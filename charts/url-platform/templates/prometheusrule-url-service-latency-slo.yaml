{{- if .Values.monitoring.prometheusRules.latencySLO.enabled }}
{{- $ns := .Release.Namespace -}}
{{- $threshold := .Values.monitoring.prometheusRules.latencySLO.thresholdSeconds | default "0.5" -}}
{{- $budget := .Values.monitoring.prometheusRules.latencySLO.errorBudgetFraction | default 0.05 -}}

{{- $fastShort := .Values.monitoring.prometheusRules.latencySLO.fastShortWindow | default "5m" -}}
{{- $fastLong := .Values.monitoring.prometheusRules.latencySLO.fastLongWindow | default "1h" -}}
{{- $slowShort := .Values.monitoring.prometheusRules.latencySLO.slowShortWindow | default "30m" -}}
{{- $slowLong := .Values.monitoring.prometheusRules.latencySLO.slowLongWindow | default "6h" -}}

{{- $fastBurn := .Values.monitoring.prometheusRules.latencySLO.fastBurnMultiplier | default 14 -}}
{{- $slowBurn := .Values.monitoring.prometheusRules.latencySLO.slowBurnMultiplier | default 2 -}}

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "url-platform.fullname" . }}-url-service-latency-slo
  namespace: {{ $ns }}
  labels:
    {{- with .Values.monitoring.prometheusRules.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
    - name: url-service.slo.latency
      rules:
        - alert: UrlServiceLatencySLOFastBurn
          expr: |
            (
              (
                (
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $fastShort }}]))
                -
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le={{ $threshold | quote }}}[{{ $fastShort }}]))
                )
                /
                clamp_min(sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $fastShort }}])), 1e-9)
              )
              / {{ $budget }}
            ) > {{ $fastBurn }}
            and
            (
              (
                (
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $fastLong }}]))
                -
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le={{ $threshold | quote }}}[{{ $fastLong }}]))
                )
                /
                clamp_min(sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $fastLong }}])), 1e-9)
              )
              / {{ $budget }}
            ) > {{ $fastBurn }}
          for: {{ .Values.monitoring.prometheusRules.latencySLO.fastBurnFor | default "2m" }}
          labels:
            severity: {{ .Values.monitoring.prometheusRules.latencySLO.fastSeverity | default "page" | quote }}
            service: url-service
            env: {{ .Values.global.appEnv | default "unknown" | quote }}
          annotations:
            summary: "url-service latency SLO fast burn (p95>{{ $threshold }}s)"
            description: "Error budget burn rate is high for both {{ $fastShort }} and {{ $fastLong }} windows. Users are experiencing sustained high latency."

        - alert: UrlServiceLatencySLOSlowBurn
          expr: |
            (
              (
                (
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $slowShort }}]))
                -
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le={{ $threshold | quote }}}[{{ $slowShort }}]))
                )
                /
                clamp_min(sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $slowShort }}])), 1e-9)
              )
              / {{ $budget }}
            ) > {{ $slowBurn }}
            and
            (
              (
                (
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $slowLong }}]))
                -
                  sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le={{ $threshold | quote }}}[{{ $slowLong }}]))
                )
                /
                clamp_min(sum(rate(http_request_duration_seconds_bucket{namespace="{{ $ns }}",service="url-service",le="+Inf"}[{{ $slowLong }}])), 1e-9)
              )
              / {{ $budget }}
            ) > {{ $slowBurn }}
          for: {{ .Values.monitoring.prometheusRules.latencySLO.slowBurnFor | default "15m" }}
          labels:
            severity: {{ .Values.monitoring.prometheusRules.latencySLO.slowSeverity | default "ticket" | quote }}
            service: url-service
            env: {{ .Values.global.appEnv | default "unknown" | quote }}
          annotations:
            summary: "url-service latency SLO slow burn (p95>{{ $threshold }}s)"
            description: "Error budget burn rate is moderately high for both {{ $slowShort }} and {{ $slowLong }} windows. Investigate performance regression."
{{- end }}
