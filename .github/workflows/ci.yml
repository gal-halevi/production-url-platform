name: ci

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.filter.outputs.url }}
      redirect: ${{ steps.filter.outputs.redirect }}
      analytics: ${{ steps.filter.outputs.analytics }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - id: filter
        name: Detect changed paths
        # dorny/paths-filter v3.0.2 pinned to commit SHA
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        with:
          filters: |
            url:
              - 'services/url-service/**'
            redirect:
              - 'services/redirect-service/**'
            analytics:
              - 'services/analytics-service/**'
            e2e:
              - 'docker-compose.yml'
              - 'scripts/**'
              - '.github/workflows/**'
              - 'services/**'

  unit-url-service:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.url == 'true' || needs.changes.outputs.e2e == 'true' || github.ref_name == 'main' }}
    defaults:
      run:
        working-directory: services/url-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: services/url-service/package-lock.json

      - name: Install
        run: npm ci

      - name: Unit tests
        run: npm test

  unit-redirect-service:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.redirect == 'true' || needs.changes.outputs.e2e == 'true' || github.ref_name == 'main' }}
    defaults:
      run:
        working-directory: services/redirect-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: services/redirect-service/go.mod
          cache: true

      - name: Unit tests
        run: go test ./...

  unit-analytics-service:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.analytics == 'true' || needs.changes.outputs.e2e == 'true' || github.ref_name == 'main' }}
    defaults:
      run:
        working-directory: services/analytics-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            services/analytics-service/requirements.txt
            services/analytics-service/requirements-dev.txt

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Unit tests
        run: pytest -q

  compose-e2e:
    runs-on: ubuntu-latest
    needs:
      - changes
      - unit-url-service
      - unit-redirect-service
      - unit-analytics-service
    timeout-minutes: 15
    if: >-
      ${{
        (needs.changes.outputs.e2e == 'true' || github.ref_name == 'main') &&
        needs.unit-url-service.result != 'failure' &&
        needs.unit-redirect-service.result != 'failure' &&
        needs.unit-analytics-service.result != 'failure'
      }}
    steps:
      - uses: actions/checkout@v4

      - name: Show Docker versions
        run: |
          docker version
          docker compose version

      - name: Build and start stack
        run: |
          docker compose up -d --build
          docker compose ps

      - name: Run e2e smoke
        run: |
          chmod +x scripts/e2e-smoke.sh
          scripts/e2e-smoke.sh

      - name: Dump logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color --tail=300

      - name: Teardown
        if: always()
        run: |
          docker compose down -v
