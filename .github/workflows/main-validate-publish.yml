name: main-validate-publish

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      url: ${{ steps.filter.outputs.url }}
      redirect: ${{ steps.filter.outputs.redirect }}
      analytics: ${{ steps.filter.outputs.analytics }}
      any_service: ${{ steps.filter.outputs.any_service }}
      charts_or_k8s: ${{ steps.filter.outputs.charts_or_k8s }}
      compose_affecting: ${{ steps.filter.outputs.compose_affecting }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        with:
          filters: |
            url:
              - 'services/url-service/**'
            redirect:
              - 'services/redirect-service/**'
            analytics:
              - 'services/analytics-service/**'
            any_service:
              - 'services/**'
            charts_or_k8s:
              - 'charts/**'
              - 'k8s/**'
            compose_affecting:
              - 'docker-compose.yml'
              - 'scripts/e2e-smoke.sh'

  unit-url-service:
    needs: changes
    if: ${{ needs.changes.outputs.url == 'true' }}
    uses: ./.github/workflows/_unit-url-service.yml

  unit-redirect-service:
    needs: changes
    if: ${{ needs.changes.outputs.redirect == 'true' }}
    uses: ./.github/workflows/_unit-redirect-service.yml

  unit-analytics-service:
    needs: changes
    if: ${{ needs.changes.outputs.analytics == 'true' }}
    uses: ./.github/workflows/_unit-analytics-service.yml

  compose-e2e:
    needs:
      - changes
      - unit-url-service
      - unit-redirect-service
      - unit-analytics-service
    # Conditions for running compose e2e tests:
    # 1. No unit test jobs failed (!failure)
    # 2. No unit test jobs were cancelled (!cancelled)
    # 3. Either: any service changed OR compose files changed
    # Note: Unit test jobs may be skipped if their service didn't change - that's OK
    if: |
      !failure() && !cancelled() &&
      (needs.changes.outputs.any_service == 'true' || needs.changes.outputs.compose_affecting == 'true')
    uses: ./.github/workflows/_compose-e2e.yml

  kind-helm-e2e:
    needs:
      - changes
      - compose-e2e
    # Run kind-helm e2e tests if relevant files changed AND compose-e2e didn't fail.
    # Compose-e2e may be skipped (e.g., only k8s/charts changed) - that's OK.
    # We only block if compose-e2e actually failed or was cancelled.
    if: |
      !failure() && !cancelled() &&
      (needs.changes.outputs.any_service == 'true' || needs.changes.outputs.charts_or_k8s == 'true')
    uses: ./.github/workflows/_kind-helm-e2e.yml
    secrets:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

  publish-url-service:
    needs: [changes, kind-helm-e2e]
    if: ${{ needs.changes.outputs.url == 'true' }}
    uses: ./.github/workflows/_publish-one-image.yml
    with:
      image_name: url-service
      context: services/url-service
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}

  publish-redirect-service:
    needs: [changes, kind-helm-e2e]
    if: ${{ needs.changes.outputs.redirect == 'true' }}
    uses: ./.github/workflows/_publish-one-image.yml
    with:
      image_name: redirect-service
      context: services/redirect-service
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}

  publish-analytics-service:
    needs: [changes, kind-helm-e2e]
    if: ${{ needs.changes.outputs.analytics == 'true' }}
    uses: ./.github/workflows/_publish-one-image.yml
    with:
      image_name: analytics-service
      context: services/analytics-service
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}
