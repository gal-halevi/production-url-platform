name: main-validate-publish

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      url: ${{ steps.filter.outputs.url }}
      redirect: ${{ steps.filter.outputs.redirect }}
      analytics: ${{ steps.filter.outputs.analytics }}
      any_service: ${{ steps.filter.outputs.any_service }}
      charts_or_k8s: ${{ steps.filter.outputs.charts_or_k8s }}
      compose_affecting: ${{ steps.filter.outputs.compose_affecting }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        with:
          filters: |
            url:
              - 'services/url-service/**'
            redirect:
              - 'services/redirect-service/**'
            analytics:
              - 'services/analytics-service/**'
            any_service:
              - 'services/**'
            charts_or_k8s:
              - 'charts/**'
              - 'k8s/**'
            compose_affecting:
              - 'docker-compose.yml'
              - 'scripts/e2e-smoke.sh'

  unit-url-service:
    needs: changes
    if: ${{ needs.changes.outputs.url == 'true' }}
    uses: ./.github/workflows/_unit-url-service.yml

  unit-redirect-service:
    needs: changes
    if: ${{ needs.changes.outputs.redirect == 'true' }}
    uses: ./.github/workflows/_unit-redirect-service.yml

  unit-analytics-service:
    needs: changes
    if: ${{ needs.changes.outputs.analytics == 'true' }}
    uses: ./.github/workflows/_unit-analytics-service.yml

  compose-e2e:
    needs:
      - changes
      - unit-url-service
      - unit-redirect-service
      - unit-analytics-service
    # Conditions for running compose e2e tests:
    # 1. No unit test jobs failed (!failure)
    # 2. No unit test jobs were cancelled (!cancelled)
    # 3. Either: any service changed OR compose files changed
    # Note: Unit test jobs may be skipped if their service didn't change - that's OK
    if: |
      !failure() && !cancelled() &&
      (needs.changes.outputs.any_service == 'true' || needs.changes.outputs.compose_affecting == 'true')
    uses: ./.github/workflows/_compose-e2e.yml

  helm-validate:
    needs:
      - changes
    if: |
      !failure() && !cancelled() &&
      needs.changes.outputs.charts_or_k8s == 'true'
    uses: ./.github/workflows/_helm-validate.yml

  publish-url-service:
    needs: [changes, compose-e2e, helm-validate]
    if: |
      !failure() && !cancelled() &&
      needs.changes.outputs.url == 'true'
    uses: ./.github/workflows/_publish-one-image.yml
    with:
      image_name: url-service
      context: services/url-service
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}

  publish-redirect-service:
    needs: [changes, compose-e2e, helm-validate]
    if: |
      !failure() && !cancelled() &&
      needs.changes.outputs.redirect == 'true'
    uses: ./.github/workflows/_publish-one-image.yml
    with:
      image_name: redirect-service
      context: services/redirect-service
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}

  publish-analytics-service:
    needs: [changes, compose-e2e, helm-validate]
    if: |
      !failure() && !cancelled() &&
      needs.changes.outputs.analytics == 'true'
    uses: ./.github/workflows/_publish-one-image.yml
    with:
      image_name: analytics-service
      context: services/analytics-service
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}

  update-gitops-dev:
    needs:
      - changes
      - publish-url-service
      - publish-redirect-service
      - publish-analytics-service
    if: |
      !failure() && !cancelled() &&
      (needs.changes.outputs.url == 'true' || needs.changes.outputs.redirect == 'true' || needs.changes.outputs.analytics == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: gal-halevi/production-url-platform-gitops
          ref: main
          path: gitops
          ssh-key: ${{ secrets.GITOPS_DEPLOY_KEY }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Update dev image tags (only changed services)
        working-directory: gitops
        run: |
          set -euo pipefail
          SHA_SHORT="${GITHUB_SHA::7}"
          FILE="envs/dev/values.yaml"

          if [[ "${{ needs.changes.outputs.url }}" == "true" ]]; then
            yq -i ".images.urlService.tag = \"sha-${SHA_SHORT}\"" "$FILE"
          fi

          if [[ "${{ needs.changes.outputs.redirect }}" == "true" ]]; then
            yq -i ".images.redirectService.tag = \"sha-${SHA_SHORT}\"" "$FILE"
          fi

          if [[ "${{ needs.changes.outputs.analytics }}" == "true" ]]; then
            yq -i ".images.analyticsService.tag = \"sha-${SHA_SHORT}\"" "$FILE"
          fi

          echo "Updated $FILE:"
          cat "$FILE"

      - name: Commit & push
        working-directory: gitops
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          SHA_SHORT="${GITHUB_SHA::7}"
          git add envs/dev/values.yaml
          git commit -m "gitops(dev): bump image tags to sha-${SHA_SHORT}"
          git push origin main
